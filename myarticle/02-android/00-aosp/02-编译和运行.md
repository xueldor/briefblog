## 1. 搭建编译环境

官网有详细教程https://source.android.google.cn/setup/build/initializing?hl=zh-cn

此外，经过第三方定制过的代码，搭环境可能有改变。应该由第三方提供手册。比如NXP提供的imx-p9.0.0_2.1.1-auto-ga 源码包，除了安卓官网的步骤外，还需要配置cmake和gcc-armnone-eabi-7-2018-q2-update  。NXP应该提供这些文档。

## 2. 编译

> 1. cd aosp
> 2. source build/envsetup.sh *#初始化编译环境*
> 3. lunch *#设置编译目标*
> 4. make -j8 *#开始编译 可选参数 -j  指定线程数目，一般是CPU核心数乘以2

### 2.1  out目录

`out`目录是编译之后产生的, 具体介绍如下:

- `out/target/product/[generic]/system`: 其中, `[]`表示的目录是根据你`lunch`选项生成的, 例如`generic_arm64`表示生成的是`arm`架构的64问系统.
- `out/target/product/generic/system/apk`: Android系统自带的apk文件
- `out/target/product/generic/system/bin`: 一些可执行文件(比如C编译的执行)
- `out/target/product/generic/system/lib`: 动态链接库;
- `out/targer/product/generic/system/lib/hw`: 硬件抽象层文件

### 2.2. 编译命令及解释

m   在源码树的根目录执行编译
mm   编译当前路径下所有模块，但不包含依赖
mmm [module_path]   编译指定路径下所有模块，但不包含依赖
mma   编译当前路径下所有模块，且包含依赖
mmma [module_path]   编译指定路径下所有模块，且包含依赖
make [module_name]   无参数，则表示编译整个Android代码



- make systemimage - system.img
- make userdataimage - userdata.img
- make ramdisk - ramdisk.img
- make snod - 快速打包system.img，重新生成 system.img 镜像 
- make otapackage  制作*OTA*包

**列举部分模块的编译指令**：

| 模块           | make命令                | mmm命令                              |
| -------------- | ----------------------- | ------------------------------------ |
| init           | make init               | mmm system/core/init                 |
| zygote         | make app_process        | mmm frameworks/base/cmds/app_process |
| system_server  | make services           | mmm frameworks/base/services         |
| java framework | make framework          | mmm frameworks/base                  |
| framework资源  | make framework-res      | mmm frameworks/base/core/res         |
| jni framework  | make libandroid_runtime | mmm frameworks/base/core/jni         |
| binder         | make libbinder          | mmm frameworks/native/libs/binder    |

等效于cd到对应目录，然后mm。



## 3. 模拟器运行

编译成功后，运行模拟器，先source build/envsetup.sh,lunch初始化环境，然后emulator 。因为模拟器是在PC上，PC的CPU是x86的，因此lunch时建议选择x86架构。

```
#使用emulator时,经常会起不来报各种错误。从网上收集了一些常见的错误
#1、虚拟机停在黑屏界面,点击无任何响应.此时,可能是kernel内核问题,指定正确的kernel:
./out/host/linux-x86/bin/emulator -partition-size 1024 -kernel ./prebuilts/qemu-kernel/arm/kernel-qemu-armv7 

#2、使用emulator出现comand not found，需要编译sdk
source ./build/envsetup.sh
lunch sdk
#或者
make sdk

#3、出现
#emulator: ERROR: x86_64 emulation currently requires hardware acceleration!
#Please ensure KVM is properly installed and usable.
#CPU acceleration status: This user doesn't have permissions to use KVM (/dev/kvm)
sudo apt-get install qemu-kvm cpu-checker
sudo addgroup kvm
sudo usermod -a -G kvm 你的用户名
sudo chgrp kvm /dev/kvm
sudo vim /etc/udev/rules.d/60-qemu-kvm.rules
    #60-qemu-kvm.rules添加
    KERNEL=="kvm", GROUP="kvm", MODE="0660"

#通过使用kernel-qemu-armv7内核 解决模拟器等待黑屏问题.而-partition-size 1024 则是解决警告: #system partion siez adjusted to match image file (163 MB >66 MB)

#如果你一开始编译的版本是aosp_arm-eng,使用上述命令仍然不能解决等待黑屏问题时,不妨编译#aosp_arm64-eng试试.
```
## 4. 真机运行

首先要把编译出的镜像烧录到机器。

### 4.1 线刷

android-sdk\platform-tools中有一个工具叫fastboot。fastboot 是用来与bootloader的USB通讯的PC命令行工具。他一般主要也用来向bootloader传送刷机文件进行文件分区重烧。 因此在使用时，必须有一个PC机并且USB线要始终联着。所以这种方式称为线刷。

fastboot是一种比recovery更底层的刷机模式，所以如果recovery坏了，没法卡刷了，可以用线刷的方式补救。

fastboot可以做：

解锁bootloader

```shell
#对于新款设备（2015 年及之后发布的设备）：
fastboot oem unlock
#对于老款设备（2014 年及之前发布的设备）：
fastboot flashing unlock
```

擦除分区

```
fastboot erase {partition} 
例：
fastboot erase boot
fastboot erase system
```

烧写指定分区

```
1.进入bootloader烧写模式
  adb reboot bootloader
2.查看设备
  fastboot devices 
3.开始烧写
  fastboot flash system system.img //烧写开始
  fastboot flash persist persist.img
  fastboot flash cache cache.img
  fastboot flash userdata userdata.img
  fastboot flash boot boot.img
  fastboot flash recovery recovery.img
4.重启设备
  fastboot reboot
```

烧写所有分区

```
fastboot flashall
注意：此命令会在当前目录中查找所有img文件，将这些img文件烧写到所有对应的分区中，并重新启动手机。
```

烧入zip

```
1、下载ROM，记录ROM在PC上的路径
2、重启手机进入fastboot mode，通过下面两种方法之一
	1、adb reboot bootloader (需要USB调试开关打开).
	2、关机长按音量加和电源按钮
3、清除手机数据
  fastboot -w
4、升级到ROM
  fastboot update </path/to/your/RomFile.zip>
5、你的手机将刷机并自动重启到新的ROM
```

烧写开机画面

```
fastboot flash splash1 开机画面.bmp
fastboot flashing unlock    #6.0以上设备 设备必须解锁，开始刷机（这个不同的手机厂商不同）
fastboot erase {partition}  # 擦除分区
fastboot  erase  frp    # 擦除 frp 分区，frp 即 Factory Reset Protection，用于防止用户信息在手机丢失后外泄
fastboot  flash  boot  boot.img    # 刷入 boot 分区
fastboot  flash  system  system.img    # 刷入 system 分区
fastboot  flash  recovery  recovery.img    # 刷入 recovery 分区
fastboot flashall    #烧写所有分区，注意：此命令会在当前目录中查找所有img文件，将这些img文件烧写到所有对应的分区中，并重新启动手机。
fastboot  format  data    # 格式化 data 分区
fastboot  flashing lock    # 设备上锁，刷机完毕
fastboot  continue    # 自动重启设备
fastboot reboot# 重启手机
fastboot reboot-bootloader# 重启到bootloader 刷机用
fastboot devices  ## 发现手机，显示当前哪些手机通过fastboot连接了
```

### 4.2  卡刷

开机时进入recovery系统，recovery从SD卡中更新系统，称为卡刷。sideload功能可以让你不用事先将ROM包拷贝至SD卡或手机内存。

官方的recovery会校验ota包的签名，而且各样功能都比较弱，可以用第三方recovery。好用的第三方RE:[TWRP](https://link.jianshu.com/?t=http://www.baidu.com/link?url=sb7qYey9n4Y14tP2hXzpv9wLEKMFsEuZsSOmgU_x56u) 和 CWM。刷入第三方recovery需要用线刷： fastboot flash recovery recovery.img。并且需要先解锁。谷歌的手机可以直接用fastboot命令解锁。现代大部分手机解锁都需要像官方申请解锁码。还有些手机不能解锁，不支持刷机。

### 4.3  厂家烧录

一般主板上都留有串口，可以通过串口将完整系统灌装到芯片里。这是厂家量产的方式，一开始芯片没有uboot没有recovery，刚刚组装好硬件，软件是完全一片空白的时候，都是用这种方式。

烧录工具和使用方法是芯片供应商提供的，比如我们现在做的项目，NXP提供了“母片工具2.0+.zip”这个烧录工具，将串口的boot和GND引脚短接，运行程序，就能通过USB口将编译出的镜像烧录到车机里面。以前做过MTK的项目，MTK提供的烧录工具和方法不一样，但是原理都差不多。